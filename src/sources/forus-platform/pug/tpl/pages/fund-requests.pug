.app.app-container
    menu
    section.app.app-content(ng-if='$ctrl.validatorRequests')
        .card-heading: .row
            .col.col-lg-3.col-xs-12 Aanvragen ({{ $ctrl.validatorRequests.meta.total }})
            .block.block-inline-filters.col.col-lg-9.col-xs-12.text-right
                .button.button-primary(ng-if="!$ctrl.extendedView" ng-click="$ctrl.setExtendedView(true)")
                    em.mdi.mdi-arrow-expand-vertical.icon-start
                    | Alles uitklappen

                .button.button-primary(ng-if="$ctrl.extendedView" ng-click="$ctrl.setExtendedView(false)")
                    em.mdi.mdi-arrow-collapse-vertical.icon-start
                    | Alles inklappen

                .button.button-text(ng-if="$ctrl.filters.show" ng-click="$ctrl.filters.reset()")
                    em.mdi.mdi-close.icon-start 
                    span(i18n="validation_requests.buttons.clear_filter")
                
                .form(ng-if="!$ctrl.filters.show")
                    input(ng-model="$ctrl.filters.values.q" type="text" placeholder="{{ 'validation_requests.labels.search' | i18n }}").form-control
                
                .inline-filters-dropdown.pull-right(click-outside="$ctrl.hideFilters()")
                    .inline-filters-dropdown-content(ng-show="$ctrl.filters.show")
                        .arrow-box.bg-dim: .arrow
                        .form
                            .form-group
                                form-label-toggle(label="{{ 'validation_requests.labels.search' | i18n }}" is-active)
                                input(
                                    ng-model="$ctrl.filters.values.q" 
                                    placeholder="{{ 'validation_requests.labels.search' | i18n }}").form-control
                            .form-group
                                form-label-toggle(label="{{ 'validation_requests.labels.status' | i18n }}")
                                select(
                                    ng-options="state.key as state.name for state in $ctrl.states" 
                                    ng-model="$ctrl.filters.values.state").form-control
                            .form-group
                                form-label-toggle(label="{{ 'validation_requests.labels.assigned_to' | i18n }}")
                                select(
                                    ng-options="employee.id as employee.email for employee in $ctrl.employees.data" 
                                    ng-model="$ctrl.filters.values.employee_id").form-control
                            .form-group
                                form-label-toggle(label="{{ 'validation_requests.labels.from' | i18n }}")
                                datepicker(
                                    date-format="dd-MM-yyyy" 
                                    datepicker-mobile=""
                                    date-week-start-day="1").form-control
                                    input(ng-model="$ctrl.filters.values.from" type="text" placeholder="dd-MM-yyyy").form-control
                            .form-group
                                form-label-toggle(label="{{ 'validation_requests.labels.to' | i18n }}")
                                datepicker(
                                    date-format="dd-MM-yyyy" 
                                    datepicker-mobile=""
                                    date-week-start-day="1").form-control
                                    input(ng-model="$ctrl.filters.values.to" type="text" placeholder="dd-MM-yyyy").form-control
                            .form-actions
                                button.button.button-primary.button-wide(
                                    ng-click="$ctrl.exportRequests()"
                                    ng-disabled="$ctrl.validatorRequests.meta.total == 0")
                                    em.mdi.mdi-download.icon-start  
                                    span.ng-scope(translate="components.dropdown.export" translate-values="{ total: $ctrl.validatorRequests.meta.total }")

                    .button.button-default.button-icon(ng-click="$ctrl.filters.show = !$ctrl.filters.show"): em.mdi.mdi-filter-outline

        .card.card-collapsable(
            ng-class="{'card-collapsed' : !validatorRequest.collapsed}"
            ng-repeat='validatorRequest in $ctrl.validatorRequests.data')
            .card-section(ng-click='validatorRequest.collapsed = !validatorRequest.collapsed')
                .card-section-actions(ng-show="validatorRequest.state == 'pending'")
                    .flex.flex-end: .tag.tag-primary-light
                        em.mdi.mdi-circle-outline.icon-start
                        span(translate='validation_requests.status.hold')
                    .card-section-actions-details: .flex-row.nowrap
                        .flex-col
                            .card-section-actions-label(translate="validation_requests.labels.lead_time")
                            .card-section-actions-value(ng-bind="validatorRequest.lead_time_locale")
                        .flex-col
                            .card-section-actions-label(translate="validation_requests.labels.pending_since")
                            .card-section-actions-value(ng-bind="validatorRequest.created_at_locale")

                .card-section-actions(ng-show="validatorRequest.state == 'disregarded'")
                    .flex.flex-end: .tag.tag-default
                        em.mdi.mdi-circle-outline.icon-start
                        span(translate='validation_requests.status.disregarded')
                    .card-section-actions-details: .flex-row.nowrap
                        .flex-col
                            .card-section-actions-label(translate="validation_requests.labels.lead_time")
                            .card-section-actions-value(ng-bind="validatorRequest.lead_time_locale")
                        .flex-col
                            .card-section-actions-label(translate="validation_requests.labels.disregarded_at")
                            .card-section-actions-value(ng-bind="validatorRequest.resolved_at_locale")         
                
                .card-section-actions(ng-show="validatorRequest.state == 'approved'")
                    .flex.flex-end: .tag.tag-success 
                        em.mdi.mdi-circle-slice-8.icon-start
                        | Geaccepteerd
                    .card-section-actions-details
                        .card-section-actions-label(translate="validation_requests.labels.accepted_at")
                        .card-section-actions-value(ng-bind="validatorRequest.resolved_at_locale")
                
                .card-section-actions(ng-show="validatorRequest.state == 'approved_partly'")
                    .tag.tag-success 
                        em.mdi.mdi-circle-slice-4.icon-start
                        | Aanvulling gevraagd
                
                .card-section-actions(ng-show="validatorRequest.state == 'declined'")
                    .flex.flex-end: .tag.tag-danger 
                        em.mdi.mdi-circle-off-outline.icon-start
                        | Geweigerd
                    .card-section-actions-details
                        .card-section-actions-label(translate="validation_requests.labels.declined_at")
                        .card-section-actions-value(ng-bind="validatorRequest.resolved_at_locale")
                
                .card-title(ng-class="{'text-muted':!validatorRequest.bsn}")
                    | BSN: 
                    span(ng-bind="validatorRequest.bsn || 'Geen data'")
                
                .card-block.card-block-listing.card-block-listing-inline
                    .card-block-listing-label Fonds
                    .card-block-listing-value
                        span(ng-bind="validatorRequest.fund.name") 
                        em.mdi.mdi-information.block.block-tooltip-details(
                            ng-click="$ctrl.showFundCriteria($event, validatorRequest)"
                            ng-class="{active: validatorRequest.showCriteria}")
                            .tooltip-content(
                                ng-if="validatorRequest.showCriteria" 
                                click-outside="$ctrl.hideFundCriteria($event, validatorRequest)"): ul.tooltip-list
                                li(ng-repeat="criterion in validatorRequest.fund.criteria").tooltip-list-item
                                    em.mdi.mdi-check
                                    | {{ criterion.record_type_name }} moet 
                                    span(ng-if="criterion.operator == '>'") meer dan 
                                    span(ng-if="criterion.operator == '='") 
                                    span(ng-if="criterion.operator == '<'") minder dan 
                                    | {{ criterion.record_type_key == 'net_worth' ? 'â‚¬' : '' }}{{ criterion.value }}.
                
                .card-block.card-block-listing(ng-if="validatorRequest.note")
                    .card-block-listing-label Reden van weigeren
                    .card-block-listing-value
                        span(ng-bind="validatorRequest.note")
            
            .card-header.card-header-cursor-default(
                ng-hide='validatorRequest.collapsed' 
                state="{{ validatorRequest.state }}" 
                assigned="{{ validatorRequest.is_assigned }}")

                .arrow-box.border.bg-dim: .arrow
                .card-title.card-title-sm: .flex
                    .flex.flex-grow
                        translate(
                            ng-if="!validatorRequest.can_add_partner_bsn" 
                            translate="validation_requests.labels.records")

                        .button.button-text(
                            ng-if="validatorRequest.can_add_partner_bsn" 
                            ng-click="$ctrl.appendRecord(validatorRequest)")
                            translate(translate="validation_requests.labels.records")
                            .mdi.mdi-plus-circle.icon-end.text-primary

                    .flex-row(ng-show="validatorRequest.state == 'pending' || validatorRequest.state == 'disregarded'")
                        //- Assign myself
                        button.button(
                            ng-if="validatorRequest.is_assignable"
                            ng-click='$ctrl.assignRequest(validatorRequest)'
                            ng-class="validatorRequest.is_assignable_as_supervisor ? 'button-default' : 'button-primary'")

                            em.mdi.mdi-account-plus.icon-start
                            | Toewijzen aan mij

                        //- Assign someone else
                        button.button.button-primary(
                            ng-if="validatorRequest.is_assignable_as_supervisor"
                            ng-click='$ctrl.assignRequestAsSupervisor(validatorRequest)')

                            em.mdi.mdi-account-details-outline.icon-start
                            | Toewijzen

                        //- Resign request
                        button.button.button-primary-light(
                            ng-if="validatorRequest.can_resign || validatorRequest.can_resign_as_supervisor"
                            ng-click='$ctrl.requestResign(validatorRequest)')

                            em.mdi.mdi-account-minus.icon-start
                            | Meld af

                        //- Decline
                        button.button.button-default(
                            ng-if="validatorRequest.state == 'pending' && validatorRequest.is_assigned && !validatorRequest.can_disregarded_undo" 
                            ng-click='$ctrl.requestDecline(validatorRequest)')

                            em.mdi.mdi-close-circle.icon-start
                            translate(translate="validation_requests.buttons.decline_all")

                        //- Approve
                        button.button.button-primary(
                            ng-if="validatorRequest.state == 'pending' && validatorRequest.is_assigned && !validatorRequest.can_disregarded_undo" 
                            ng-click='$ctrl.requestApprove(validatorRequest)')

                            em.mdi.mdi-check-circle.icon-start
                            translate(translate="validation_requests.buttons.accept_all")

                        //- Disregard
                        button.button.button-default(
                            ng-if="validatorRequest.can_disregarded" 
                            ng-click='$ctrl.requestDisregard(validatorRequest)')

                            em.mdi.mdi-timer-sand-empty.icon-start
                            translate(translate="validation_requests.buttons.disregard")
                    
                        //- Disregard undo
                        button.button.button-default(
                            ng-if="validatorRequest.can_disregarded_undo" 
                            ng-click='$ctrl.requestDisregardUndo(validatorRequest)')
                            em.mdi.mdi-timer-sand-empty.icon-start
                            translate(translate="validation_requests.buttons.disregard_undo")
        
            .card-section(ng-hide='validatorRequest.collapsed'): .card-block.card-block-table: .table-wrapper: table.table
                thead: tr
                    th.cell-chevron(ng-if="validatorRequest.hasContent")
                    th(translate='validation_requests.labels.type' width="20%")
                    th(translate='validation_requests.labels.value' width="20%")
                    th(translate='validation_requests.labels.date' width="20%")
                    th(translate='validation_requests.labels.status' width="20%")
                    th.text-right(translate='validation_requests.labels.actions' width="20%")
                
                tbody(ng-repeat='record in validatorRequest.records')
                    tr
                        td.cell-chevron(ng-if="validatorRequest.hasContent"): a.mdi.mdi-menu-down.td-menu-icon(
                            ng-if="(record.files.length > 0) || (record.clarifications.length > 0)"
                            ng-class="{'mdi-menu-down': !record.shown, 'mdi-menu-up': record.shown}"
                            ng-click="record.shown = !record.shown")
                        td(ng-bind='record.record_type.name')
                        td(ng-bind='record.value !== null ? record.value : "Niet beschikbaar"' ng-class="{'text-muted': record.value !== null}")
                        td(ng-bind='record.created_at_locale')
                        td: .tag(
                            ng-class="{pending: 'tag-primary-light', declined: 'tag-danger', approved: 'tag-success', disregarded: 'tag-default'}[record.state]" 
                            translate='validation_requests.status.{{ record.state }}')
                        
                        td.text-right(ng-if="record.state != 'pending'")
                            .text-muted(translate='validation_requests.status.{{ record.state }}')

                        td.text-right(ng-if="record.state == 'pending' && !record.is_assigned")
                            .td-text-insert.text-muted(ng-if="record.employee_id")
                                span Toegewezen aan
                                .text-strong.nowrap(ng-bind="record.employee.email")

                            .text-muted(ng-if="!record.employee_id && record.is_assignable")
                                | Zelf toewijzen

                            .text-muted(ng-if="!record.employee_id && !record.is_assignable")
                                | Niet beschikbaar

                        td.text-right(ng-if="record.state == 'pending' && record.is_assigned")
                            .button-group.flex-end
                                .button.button-primary.button-icon(
                                    ng-click='$ctrl.declineRecord(validatorRequest, record)' 
                                    ng-if='$root.appConfigs.flags.singleRecordValidation')
                                    em.mdi.mdi-close

                                .button.button-primary-light.button-icon(
                                    ng-click='$ctrl.clarifyRecord(validatorRequest, record)')
                                    em.mdi.mdi-message-text

                                .button.button-default.button-icon(
                                    ng-click='$ctrl.approveRecord(validatorRequest, record)' 
                                    ng-if='$root.appConfigs.flags.singleRecordValidation')
                                    em.mdi.mdi-check
                    
                    tr.dim(ng-if='(record.shown) && ((record.files.length > 0) || (record.clarifications.length > 0))'): td(colspan='6')
                        .block.block-attachments-list(ng-if='record.files.length > 0'): .block-attachments-inner
                            a.attachment-item(ng-repeat='file in record.files' ng-click='$ctrl.downloadFile(file)')
                                .attachment-icon
                                    .mdi.mdi-file
                                    .attachment-size(ng-bind='file.size')

                                .attachment-name(ng-bind='file.original_name')
                                .attachment-date(ng-bind='record.created_at_locale')
                                .attachment-preview( 
                                    ng-if="file.ext == 'pdf'"
                                    title="file.ext == 'pdf' ? 'Bekijk PDF-bestand' : 'Bekijk file'"
                                    ng-click="$ctrl.previewFile($event, file)")
                                    .mdi.mdi-eye
                        
                        .block.block-request-clarification(ng-if='record.clarifications.length > 0')
                            .block-title Aanvullingen
                            .clarification-item(ng-repeat="clarification in record.clarifications")
                                .clarification-item-nth(ng-bind="$index + 1")
                                .clarification-item-details
                                    .clarification-item-question
                                        .clarification-item-icon.mdi.mdi-message-text.text-primary
                                        span(ng-bind="clarification.question")

                                    .clarification-item-answer
                                        .clarification-item-icon.mdi.mdi-message-text.text-primary-light
                                        span(
                                            ng-class="clarification.answered_at ? '' : 'text-muted'"
                                            ng-bind="clarification.answered_at ? clarification.answer : 'Geen antwoord...'")

                                    .clarification-item-attachments(ng-if="clarification.files.length > 0")
                                        .block.block-attachments-list
                                            .block-attachments-inner
                                                a.attachment-item(
                                                    ng-repeat='file in clarification.files' 
                                                    ng-click='$ctrl.downloadFile(file)')
                                                    .attachment-icon
                                                        .mdi.mdi-file
                                                        .attachment-size(ng-bind='file.size')
                                                    .attachment-name(ng-bind='file.original_name')
                                                    .attachment-preview(
                                                        title="Bekijk file"
                                                        ng-if="$ctrl.hasFilePreview(file)" 
                                                        ng-click="$ctrl.previewFile($event, file)")
                                                        .mdi.mdi-eye

            .card-header(
                ng-if="$ctrl.organization.has_person_bsn_api && validatorRequest.bsn"
                ng-click='validatorRequest.bsn_collapsed = !validatorRequest.bsn_collapsed')
                .card-title
                    | Persoonlijke gegevens &nbsp;
                    .button.button-default(
                        ng-click="$event.stopPropagation(); $ctrl.getPerson(validatorRequest, validatorRequest.bsn)")
                        .mdi.mdi-reload.mdi-spin.icon-start(ng-if="$ctrl.fetchingPerson")
                        .mdi.mdi-eye.icon-start(ng-if="!$ctrl.fetchingPerson")
                        | Bekijken

            .card-section(ng-if="$ctrl.organization.has_person_bsn_api && validatorRequest.person" ng-hide='validatorRequest.bsn_collapsed')
                .arrow-box.border.bg-dim: .arrow

                .block.block-breadcrumbs
                    .breadcrumb-item(
                        ng-repeat="breadcrumb in validatorRequest.person_breadcrumbs track by $index"
                        ng-init="breadcrumbIndex = $index"
                        ng-bind="breadcrumb.name"
                        ng-click="$ctrl.getPerson(validatorRequest, breadcrumb.bsn, breadcrumbIndex > 0 ? validatorRequest.person_breadcrumbs[breadcrumbIndex-1].bsn : null)")

                .row
                    .col.col-lg-6: .flex: .card-block.card-block-keyvalue
                        .keyvalue-item
                            .keyvalue-key(translate="validation_requests.labels.bsn")
                            .keyvalue-value(ng-bind="validatorRequest.person.bsn")
                        .keyvalue-item
                            .keyvalue-key(translate="validation_requests.labels.first_name")
                            .keyvalue-value(ng-bind="validatorRequest.person.first_name")
                        .keyvalue-item
                            .keyvalue-key(translate="validation_requests.labels.last_name")
                            .keyvalue-value(ng-bind="validatorRequest.person.last_name")
                        .keyvalue-item
                            .keyvalue-key(translate="validation_requests.labels.gender")
                            .keyvalue-value(ng-bind="validatorRequest.person.gender")
                        .keyvalue-item
                            .keyvalue-key(translate="validation_requests.labels.nationality")
                            .keyvalue-value(ng-bind="validatorRequest.person.nationality")
                        .keyvalue-item
                            .keyvalue-key(translate="validation_requests.labels.age")
                            .keyvalue-value(ng-bind="validatorRequest.person.age")
                        .keyvalue-item
                            .keyvalue-key(translate="validation_requests.labels.birth_date")
                            .keyvalue-value(ng-bind="validatorRequest.person.birth_date")
                        .keyvalue-item
                            .keyvalue-key(translate="validation_requests.labels.birth_place")
                            .keyvalue-value(ng-bind="validatorRequest.person.birth_place.place + ', ' + validatorRequest.person.birth_place.country")
                        .keyvalue-item
                            .keyvalue-key(translate="validation_requests.labels.address")
                            .keyvalue-value
                                | {{ validatorRequest.person.residence.street }} {{ validatorRequest.person.residence.house_number }}
                                br
                                | {{ validatorRequest.person.residence.postcode }}

                    .col.col-lg-6: .flex: .card-block.card-block-keyvalue
                        .keyvalue-item(ng-repeat="parent in validatorRequest.person.parents track by $index" ng-init="parentIndex = $index")
                            .keyvalue-key(translate="validation_requests.labels.parent" translate-values="{ index: parentIndex + 1 }")
                            .keyvalue-value(
                                ng-bind="parent.name"
                                ng-class="parent.bsn ? 'card-text-link' : ''"
                                ng-click="$ctrl.getPerson(validatorRequest, parent.bsn, validatorRequest.person.bsn)")

                        .keyvalue-item(ng-repeat="partner in validatorRequest.person.partners track by $index" ng-init="partnerIndex = $index")
                            .keyvalue-key(translate="validation_requests.labels.partner")
                            .keyvalue-value(
                                ng-bind="partner.name"
                                ng-class="partner.bsn ? 'card-text-link' : ''"
                                ng-click="$ctrl.getPerson(validatorRequest, partner.bsn, validatorRequest.person.bsn)")

                        .keyvalue-item(ng-repeat="child in validatorRequest.person.children track by $index" ng-init="childIndex = $index")
                            .keyvalue-key(translate="validation_requests.labels.child" translate-values="{ index: childIndex + 1 }")
                            .keyvalue-value(
                                ng-bind="child.name"
                                ng-class="child.bsn ? 'card-text-link' : ''"
                                ng-click="$ctrl.getPerson(validatorRequest, child.bsn, validatorRequest.person.bsn)")


        .card-section(ng-show='$ctrl.shownUsers[validatorRequest.bsn] && !validatorRequest.collapsed'): .table-pagination
            .table-pagination-counter(
                translate='validation_requests.labels.results' 
                translate-values='{count: validatorRequest.requests.length}')
        
        .card: .card-section(ng-show='$ctrl.validatorRequests.meta.last_page > 1'): paginator(
            meta='$ctrl.validatorRequests.meta' 
            filters='$ctrl.filters.values' 
            count-buttons='5' 
            on-page-change='$ctrl.onPageChange(query)')
        
        block-empty(
            ng-if='$ctrl.validatorRequests.data.length == 0' 
            text='Geen aanmeldingen.')
