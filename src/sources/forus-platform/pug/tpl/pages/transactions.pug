.app.app-container
    menu
    section.app.app-content
        .card
            .card-header: .flex-row
                //- Transactions title
                .flex.flex-grow(ng-if="$ctrl.viewType.key == 'transactions'"): .card-title
                    span(i18n="transactions.header.title") 
                    span(ng-bind="$ctrl.transactions.meta.total").span-count

                //- Transaction bulks title
                .flex.flex-grow(ng-if="$ctrl.viewType.key == 'bulks'"): .card-title
                    span(i18n="transactions.header.titleBulks") 
                    span(ng-bind="$ctrl.transactionBulks.meta.total").span-count

                //- Filters
                .flex: .block.block-inline-filters
                    .button.button-text(ng-if="$ctrl.viewType.key == 'transactions' && $ctrl.filters.show" ng-click="$ctrl.filters.reset()")
                        em.mdi.mdi-close.icon-start
                        span(i18n="Wis filters")

                    .form(ng-if="$ctrl.viewType.key == 'transactions' && !$ctrl.filters.show"): .form-group: input(
                        ng-model="$ctrl.filters.values.q" 
                        placeholder="{{ 'transactions.labels.search' | i18n }}").form-control

                    .form(ng-if="$ctrl.viewType.key == 'transactions'"): .inline-filters-dropdown.pull-right(click-outside="$ctrl.hideFilters()")
                        .inline-filters-dropdown-content(ng-show="$ctrl.filters.show")
                            .arrow-box.bg-dim: .arrow
                            .form
                                .form-group
                                    form-label-toggle(label="{{ 'transactions.labels.search' | i18n }}" is-active)
                                    input(
                                        ng-model="$ctrl.filters.values.q" 
                                        placeholder="{{ 'transactions.labels.search' | i18n }}").form-control
                                .form-group
                                    form-label-toggle(label="{{ 'transactions.labels.amount' | i18n }}")
                                    .row
                                        .col.col-lg-6: input(
                                            type="number" 
                                            ng-model="$ctrl.filters.values.amount_min" 
                                            placeholder="{{ 'transactions.labels.amount_min' | i18n }}").form-control

                                        .col.col-lg-6: input(
                                            type="number" 
                                            ng-model="$ctrl.filters.values.amount_max" 
                                            placeholder="{{ 'transactions.labels.amount_max' | i18n }}").form-control

                                .form-group
                                    form-label-toggle(label="{{ 'transactions.labels.state' | i18n }}")
                                    select(
                                        ng-options="state.key as state.name for state in $ctrl.states" 
                                        ng-model="$ctrl.filters.values.state").form-control

                                .form-group
                                    form-label-toggle(label="{{ 'transactions.labels.from' | i18n }}")
                                    datepicker(
                                        date-format="yyyy-MM-dd" 
                                        datepicker-mobile=""
                                        date-week-start-day="1").form-control
                                        input(ng-model="$ctrl.filters.values.from" type="text" placeholder="jjjj-MM-dd").form-control

                                .form-group
                                    form-label-toggle(label="{{ 'transactions.labels.to' | i18n }}")
                                    datepicker(
                                        date-format="yyyy-MM-dd" 
                                        datepicker-mobile="" 
                                        date-week-start-day="1").form-control
                                        input(ng-model="$ctrl.filters.values.to" type="text" placeholder="jjjj-MM-dd").form-control

                                .form-group
                                    form-label-toggle(label="{{ 'transactions.labels.fund_state' | i18n }}")
                                    select(
                                        ng-options="state.key as state.name for state in $ctrl.fundStates" 
                                        ng-model="$ctrl.filters.values.fund_state").form-control

                                .form-actions
                                    button.button.button-primary.button-wide(
                                        ng-click="$ctrl.exportList()"
                                        ng-disabled="$ctrl.transactions.meta.total == 0")
                                        em.mdi.mdi-download.icon-start  
                                        span.ng-scope(translate="components.dropdown.export" translate-values="{ total: $ctrl.transactions.meta.total }")

                        .button.button-default.button-icon(ng-click="$ctrl.filters.show = !$ctrl.filters.show"): em.mdi.mdi-filter-outline

                    //- View type
                    .flex(ng-if="$ctrl.isSponsor"): div: .block.block-label-tabs: .label-tab-set: .label-tab.label-tab-sm(
                        ng-repeat="viewType in $ctrl.viewTypes" 
                        ng-class="{active: $ctrl.viewType == viewType}"
                        ng-click="$ctrl.setViewType(viewType)"
                        ng-bind="viewType.label")

            //- Transactions
            .card-section(ng-if="$ctrl.viewType.key == 'transactions' && $ctrl.transactions.meta.total > 0")
                .card-block.card-block-table
                    .table-wrapper
                        table.table
                            tr
                                th(i18n="financial_dashboard_transaction.labels.id")
                                th(i18n="transactions.labels.price")
                                th(i18n="transactions.labels.date")
                                th(i18n="transactions.labels.fund")
                                th(i18n="transactions.labels.provider")
                                th(i18n="transactions.labels.bulk" ng-if="$ctrl.isSponsor")
                                th(i18n="transactions.labels.status")
                                th.th-narrow.text-right(i18n="transactions.labels.action")

                            tr(ng-repeat="transaction in $ctrl.transactions.data")
                                td(ng-bind="transaction.id")
                                td: a.text-primary-light(
                                    ng-bind="transaction.amount | currency_format" 
                                    ui-sref="transaction(transaction.ui_sref)")

                                td(ng-bind="transaction.created_at_locale")
                                td(ng-bind="transaction.fund.name")
                                td(ng-bind="transaction.organization.name")

                                td(ng-if="$ctrl.isSponsor && transaction.voucher_transaction_bulk_id"): a(
                                    ui-sref="transaction-bulk(transaction.ui_sref_bulk)" 
                                    ng-bind="'#' + transaction.voucher_transaction_bulk_id").text-primary-light

                                td(ng-if="$ctrl.isSponsor && !transaction.voucher_transaction_bulk_id"): .text-muted(
                                    ng-bind="(transaction.state == 'pending' && transaction.attempts <= 3) ? 'Queued' : '-'")

                                td
                                    .label.label-success(ng-if="transaction.state == 'success'" ng-bind="transaction.state_locale")
                                    .label.label-default(ng-if="transaction.state != 'success'" ng-bind="transaction.state_locale")

                                td.td-narrow.text-right: a(ui-sref="transaction(transaction.ui_sref)").button.button-sm.button-primary.pull-right
                                    em.mdi.mdi-eye-outline.icon-start
                                    translate(translate="transactions.buttons.view")

            //- Transactions totals
            .card-section(ng-if="$ctrl.viewType.key == 'transactions' && $ctrl.transactions.data.length"): .flex.flex-vertical
                //- Totals and pending bulk transactions
                .flex.flex-grow: card-text
                    translate(translate="transactions.labels.total_amount")
                    | :&nbsp;
                    span(ng-bind="$ctrl.transactionsTotal | currency_format")
                    span(ng-if="$ctrl.pendingBulkingTotal && ($ctrl.organization | hasPerm:'manage_transaction_bulks')") 
                        br
                        | Transaction prepared for the the next bulk: {{ $ctrl.pendingBulkingTotal }}

                //- Build the bulk now
                .flex.flex-center(ng-if="$ctrl.pendingBulkingTotal && ($ctrl.organization | hasPerm:'manage_transaction_bulks')")
                    div: .flex.flex-center
                        button(ng-click="$ctrl.bulkPendingNow()" ng-disabled="$ctrl.buildingBulks").button.button-primary.button-sm
                            em(ng-if="!$ctrl.buildingBulks").mdi.mdi-cube-send.icon-start
                            em(ng-if="$ctrl.buildingBulks").mdi.mdi-spin.mdi-loading.icon-start
                            | Build the bulk now

            //- Transactions pagination
            .card-section(ng-if="$ctrl.viewType.key == 'transactions' && $ctrl.transactions" ng-show="$ctrl.transactions.meta.last_page > 1")
                paginator(meta="$ctrl.transactions.meta" filters="$ctrl.filters.values" on-page-change="$ctrl.onPageChange(query)")

            //- Empty transactions block
            .card-section(ng-if="$ctrl.viewType.key == 'transactions' && $ctrl.transactions.meta.total == 0"): .block.block-empty.text-center
                .empty-title No transaction found

            //- Bulk transactions
            .card-section(ng-if="$ctrl.viewType.key == 'bulks' && $ctrl.transactionBulks.meta.total > 0")
                .card-block.card-block-table: .table-wrapper: table.table
                    tr
                        th ID
                        th Bedrag
                        th Datum
                        th Aantal
                        th Status
                        th.th-narrow.text-right ACTIES

                    tr(ng-repeat="transactionBulk in $ctrl.transactionBulks.data")
                        td(ng-bind="transactionBulk.id")
                        td.text-primary-light(ng-bind="transactionBulk.voucher_transactions_amount | currency_format")
                        td(ng-bind="transactionBulk.created_at_locale")
                        td(ng-bind="transactionBulk.voucher_transactions_count")

                        td
                            .label.label-danger(ng-if="transactionBulk.state == 'rejected'" ng-bind="transactionBulk.state_locale")
                            .label.label-success(ng-if="transactionBulk.state == 'accepted'" ng-bind="transactionBulk.state_locale")
                            .label.label-default(ng-if="transactionBulk.state == 'pending'" ng-bind="transactionBulk.state_locale")

                        td.td-narrow.text-right: a(ui-sref="transaction-bulk(transactionBulk.ui_sref)").button.button-sm.button-primary.pull-right
                            em.mdi.mdi-eye-outline.icon-start
                            translate(translate="transactions.buttons.view")

            //- Bulk transactions pagination
            .card-section(ng-if="$ctrl.viewType.key == 'bulks' && $ctrl.transactionBulks" ng-show="$ctrl.transactionBulks.meta.last_page > 1")
                paginator(meta="$ctrl.transactionBulks.meta" filters="$ctrl.filters.values" on-page-change="$ctrl.onBulkPageChange(query)")
            
            //- Empty bulk transactions block
            .card-section(ng-if="$ctrl.viewType.key == 'bulks' && $ctrl.transactionBulks.meta.total == 0"): .block.block-empty.text-center
                .empty-title No transaction bulks found
                .empty-description
                    | Bulks are generated once a day at a fixed time and include all pending transactions
                    br
                    | Currently you don't have any transaction bulks.
